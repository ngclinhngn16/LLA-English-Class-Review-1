<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mid-Course Review: Lesson 1-7</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --error: #c0392b;
            --explain: #16a085;
            --translate: #8e44ad;
            --bg: #f4f6f7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg);
        }

        /* Student Info Box */
        .student-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-info input {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        h2 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        
        .instruction {
            background-color: #e8f4f8;
            color: #2980b9;
            padding: 10px 15px;
            border-radius: 5px;
            font-style: italic;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .question-block {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .question-text {
            font-weight: 600;
            font-size: 1.05em;
            margin-bottom: 10px;
        }

        /* Inputs & Selects */
        select, input[type="text"] {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            transition: 0.3s;
        }
        
        /* Specific Styles */
        .definition-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .def-item { margin-bottom: 5px; }
        .def-key { font-weight: bold; color: var(--accent); margin-right: 5px; }

        /* Buttons */
        .btn-group { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        button {
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            font-size: 0.9em;
        }
        .btn-check { background-color: var(--accent); }
        .btn-check:hover { background-color: #2980b9; }
        
        .btn-explain { background-color: var(--explain); display: none; } /* Hidden by default */
        .btn-trans { background-color: var(--translate); display: none; } /* Hidden by default */

        /* Feedback States */
        .correct-input { border-color: var(--success) !important; background-color: #eafaf1; }
        .incorrect-input { border-color: var(--error) !important; background-color: #fceae9; }

        .feedback-msg {
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .text-success { color: var(--success); }
        .text-error { color: var(--error); }
        .retry-note { font-weight: normal; color: #7f8c8d; font-size: 0.9em; margin-left: 5px; }

        /* Hidden Info Boxes */
        .info-box {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.95em;
        }
        .explain-box { background-color: #e8f8f5; border-left: 4px solid var(--explain); color: #0e6655; }
        .trans-box { background-color: #f5eef8; border-left: 4px solid var(--translate); color: #5b2c6f; }

        /* Score Box */
        .score-board {
            position: sticky;
            bottom: 0;
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-score { font-weight: bold; font-size: 1.4em; color: #f1c40f; }
        .btn-submit-all {
            background-color: #f1c40f;
            color: #2c3e50;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ENGLISH MID-COURSE REVIEW</h1>
    </div>

    <div class="student-info">
        <label for="studentName"><strong>Họ và Tên học viên:</strong></label>
        <input type="text" id="studentName" placeholder="Nhập tên của bạn vào đây...">
    </div>

    <div class="section">
        <h2>Task 1</h2>
        <div class="instruction">Instruction: Match the term in the list with its correct definition (A-F).</div>
        
        <div class="definition-list">
            <div class="def-item"><span class="def-key">A.</span> A quick, temporary fix for a bug directly on the live server.</div>
            <div class="def-item"><span class="def-key">B.</span> A simulation environment that mimics real hardware but isn't real.</div>
            <div class="def-item"><span class="def-key">C.</span> The uncontrolled expansion of project goals/features without adjusting time/budget.</div>
            <div class="def-item"><span class="def-key">D.</span> A critical issue that halts the entire process/release.</div>
            <div class="def-item"><span class="def-key">E.</span> The amount of data that can be transmitted (or a team's capacity to work).</div>
            <div class="def-item"><span class="def-key">F.</span> The action of reducing the severity or likelihood of a risk.</div>
        </div>

        <div id="part1-container"></div>
    </div>

    <div class="section">
        <h2>Task 2</h2>
        <div class="instruction">Instruction: Choose the correct word pair to complete the comparison sentence.</div>
        <div id="part2-container"></div>
    </div>

    <div class="section">
        <h2>Task 3</h2>
        <div class="instruction">Instruction: The <b>bold text</b> is logically incorrect. Choose the best option to fix it.</div>
        <div id="part3-container"></div>
    </div>

    <div class="section">
        <h2>Task 4</h2>
        <div class="instruction">Instruction: Read the situation and choose the best response for the second speaker.</div>
        <div id="part4-container"></div>
    </div>

    <div class="section">
        <h2>Task 5</h2>
        <div class="instruction">Instruction: Fill in the blanks with the words: <b>held up, elaborate, workaround, rather, regarding</b>.</div>
        <div id="part5-container"></div>
    </div>

    <div class="section">
        <h2>Task 6</h2>
        <div class="instruction">Instruction: Reorder the keywords to make a complete professional sentence.</div>
        <div id="part6-container"></div>
    </div>

    <div class="section">
        <h2>Task 7</h2>
        <div class="instruction">Instruction: Complete the email by filling in the blanks.</div>
        <div style="background: #fdfdfd; padding: 20px; border: 1px solid #ccc; border-radius: 5px;">
            <p><strong>Subject:</strong> Project Status Update</p>
            <p>Dear Client,</p>
            <p>I am writing to update you on the project status. Unfortunately, we are currently at a 
                (1) <input type="text" id="p7-q1" class="scorable" style="width: 120px;"> <span id="fb-p7-q1"></span>.
            </p>
            <p>This morning, the testing team identified a critical bug. It is a 
                (2) <input type="text" id="p7-q2" class="scorable" style="width: 120px;"> <span id="fb-p7-q2"></span> because users cannot log in.
            </p>
            <p>Specifically, the "Login" button is 
                (3) <input type="text" id="p7-q3" class="scorable" style="width: 120px;"> <span id="fb-p7-q3"></span> with the "Sign Up" text, making it unclickable.
            </p>
            <p>This issue only happens on Real Devices, not on the 
                (4) <input type="text" id="p7-q4" class="scorable" style="width: 120px;"> <span id="fb-p7-q4"></span>.
            </p>
            <p>We have a 
                (5) <input type="text" id="p7-q5" class="scorable" style="width: 120px;"> <span id="fb-p7-q5"></span> plan:
            </p>
            <ol>
                <li>The Dev team will fix the UI code today.</li>
                <li>We need you to (6) <input type="text" id="p7-q6" class="scorable" style="width: 120px;"> <span id="fb-p7-q6"></span> the expected screen size for the new iPad.</li>
            </ol>
            <p>Best regards,<br>Project Manager.</p>
        </div>
        <br>
        <div class="btn-group">
            <button class="btn-check" onclick="checkPart7()">Check Task 7</button>
            <button id="btn-exp-p7" class="btn-explain" onclick="toggle('exp-p7')">Giải thích</button>
            <button id="btn-trans-p7" class="btn-trans" onclick="toggle('trans-p7')">Dịch nghĩa</button>
        </div>
        <div id="fb-p7-main" class="feedback-msg"></div>
        <div id="exp-p7" class="info-box explain-box">
            <b>Đáp án:</b> 1. Red Light | 2. Showstopper | 3. Overlapping | 4. Simulator | 5. Mitigation | 6. Clarify
        </div>
        <div id="trans-p7" class="info-box trans-box">
            Thưa Khách hàng, tôi viết để cập nhật trạng thái. Chúng tôi đang ở mức Báo động Đỏ. Sáng nay phát hiện lỗi nghiêm trọng (Showstopper). Nút Login bị chồng chéo (Overlapping). Lỗi này không bị trên Giả lập (Simulator). Chúng tôi có kế hoạch giảm thiểu (Mitigation). Cần bạn làm rõ (Clarify) kích thước màn hình.
        </div>
    </div>

    <div class="score-board">
        <div>
            KẾT QUẢ: <span id="total-score" class="total-score">0</span> / 32
        </div>
        <div>
            <button class="btn-submit-all" onclick="calculateTotalScore()">Cập nhật Điểm & Sao chép KQ</button>
        </div>
    </div>

<script>
    // --- DATA ---
    const part1Data = [
        { q: "Scope Creep", ans: "C", exp: "Sự phình to phạm vi dự án không kiểm soát.", trans: "Sự mở rộng không kiểm soát của các mục tiêu dự án." },
        { q: "Showstopper", ans: "D", exp: "Lỗi nghiêm trọng chặn đứng quy trình.", trans: "Một vấn đề nghiêm trọng làm dừng toàn bộ quy trình." },
        { q: "Mitigation", ans: "F", exp: "Hành động giảm nhẹ rủi ro.", trans: "Hành động giảm mức độ nghiêm trọng của rủi ro." },
        { q: "Hotfix", ans: "A", exp: "Bản vá lỗi nóng (ngay lập tức).", trans: "Một bản sửa lỗi nhanh trực tiếp trên hệ thống." },
        { q: "Simulator", ans: "B", exp: "Môi trường giả lập.", trans: "Môi trường mô phỏng phần cứng nhưng không phải thật." },
        { q: "Bandwidth", ans: "E", exp: "Năng lực làm việc của team (nghĩa bóng).", trans: "Khả năng làm việc của một nhóm." }
    ];

    const part2Data = [
        { 
            pre: "Unlike a ", gap1: "fixed schedule", mid: ", which requires 9-5, ", gap2: "flexible hours", post: " allows you to choose time.",
            opts: ["fixed schedule", "flexible hours"],
            exp: "Fixed: Cố định. Flexible: Linh hoạt.", trans: "Không giống lịch cố định, giờ làm việc linh hoạt cho phép bạn chọn giờ."
        },
        { 
            pre: "An ", gap1: "amber light", mid: " means risk but manageable, whereas a ", gap2: "red light", post: " means we are behind schedule.",
            opts: ["amber light", "red light"],
            exp: "Amber: Vàng (Rủi ro). Red: Đỏ (Chậm trễ).", trans: "Đèn vàng nghĩa là có rủi ro, đèn đỏ nghĩa là chậm tiến độ."
        },
        { 
            pre: "A ", gap1: "mockup", mid: " is a specific draft of our product, while a ", gap2: "reference", post: " is just an example.",
            opts: ["mockup", "reference"],
            exp: "Mockup: Bản thiết kế mẫu. Reference: Tài liệu tham khảo.", trans: "Mockup là bản nháp thiết kế, Reference là ví dụ tham khảo."
        },
        { 
            pre: "The deadline is ", gap1: "aggressive", mid: ", so honestly, it is not ", gap2: "feasible", post: " to finish on time.",
            opts: ["aggressive", "feasible"],
            exp: "Aggressive: Khắt khe/Gấp. Feasible: Khả thi.", trans: "Hạn chót quá gấp gáp, nên việc hoàn thành là không khả thi."
        }
    ];

    const part3Data = [
        {
            q: "The deadline is fixed, so we must <b>add more features</b> to finish on time.",
            opts: ["prioritize key features", "increase the scope", "assume the requirements"],
            ans: 0,
            exp: "Deadline cố định -> Phải ưu tiên (prioritize), không được thêm việc.", trans: "Hạn chót đã cố định, vì vậy chúng ta phải ưu tiên các tính năng chính."
        },
        {
            q: "I have severe eye strain, so I plan to <b>watch movies to relax</b>.",
            opts: ["take regular breaks and look away", "abuse caffeine", "use a simulator"],
            ans: 0,
            exp: "Mỏi mắt -> Cần nghỉ ngơi nhìn ra xa.", trans: "Tôi bị mỏi mắt, vì vậy tôi sẽ nghỉ giải lao và nhìn ra xa."
        },
        {
            q: "The system fails on the Real Device. This is <b>just a minor bug</b>.",
            opts: ["a green light", "a showstopper", "a mitigation plan"],
            ans: 1,
            exp: "Lỗi trên thiết bị thật là lỗi nghiêm trọng (Showstopper).", trans: "Hệ thống lỗi trên Thiết bị thật. Đây là một lỗi nghiêm trọng."
        },
        {
            q: "We are behind schedule, so the project status is currently a <b>Green Light</b>.",
            opts: ["Red Light", "Workaround", "Bottleneck"],
            ans: 0,
            exp: "Chậm tiến độ -> Đèn Đỏ (Red Light).", trans: "Chúng ta đang bị chậm tiến độ, trạng thái là Đèn Đỏ."
        }
    ];

    const part4Data = [
        {
            context: "<b>BA:</b> The user needs to upload the file.<br><b>Dev:</b> Wait. _______ Is it a PDF or a JPG?",
            opts: ["Do you have a specific mockup?", "Just to be clear, are we assuming the file format?", "What is the expected behavior?"],
            ans: 1,
            exp: "Hỏi để xác nhận giả định -> Just to be clear...", trans: "Đợi đã. Để cho rõ ràng, có phải chúng ta đang giả định định dạng file không?"
        },
        {
            context: "<b>Client:</b> I want this done in 2 days.<br><b>PM:</b> _______ We need at least 5 days to code.",
            opts: ["That timeline is extremely aggressive.", "That is feasible.", "I propose a green light."],
            ans: 0,
            exp: "Từ chối khéo vì quá gấp -> Timeline is aggressive.", trans: "Mốc thời gian đó cực kỳ gấp gáp. Chúng tôi cần ít nhất 5 ngày."
        },
        {
            context: "<b>Colleague:</b> I feel empty and tired. I think I have burnout.<br><b>You:</b> Oh no. _______",
            opts: ["You should work overtime.", "You should abuse caffeine.", "You should take some paid holidays to relax."],
            ans: 2,
            exp: "Burnout -> Cần nghỉ ngơi (Paid holidays).", trans: "Ôi không. Bạn nên xin nghỉ phép có lương để thư giãn đi."
        }
    ];

    const part5Data = [
        { q: "Could you ______ on what you mean by 'automatic'?", ans: "elaborate", exp: "Elaborate on: Giải thích thêm.", trans: "Bạn có thể giải thích rõ hơn ý bạn là gì không?" },
        { q: "There seems to be a gap ______ the logic.", ans: "regarding", exp: "Regarding: Liên quan đến.", trans: "Dường như có một lỗ hổng liên quan đến logic." },
        { q: "Actually, I'd ______ not be the MC because I am shy.", ans: "rather", exp: "I'd rather not: Tôi thà không làm.", trans: "Thực ra tôi thà không làm MC vì tôi ngại." },
        { q: "The release is being ______ by a server error.", ans: "held up", exp: "Held up: Bị trì hoãn.", trans: "Đợt phát hành đang bị trì hoãn bởi lỗi máy chủ." },
        { q: "The deadline is too tight, so I propose a ______.", ans: "workaround", exp: "Workaround: Giải pháp thay thế.", trans: "Hạn chót quá gấp, tôi đề xuất giải pháp thay thế." }
    ];

    const part6Data = [
        { q: "swap / Can / roles / we / the / presentation? / for", ans: "Can we swap roles for the presentation?", exp: "Can we + V + O?", trans: "Chúng ta có thể đổi vai cho bài thuyết trình được không?" },
        { q: "feasible / It / not / is / complete / 2 days. / in / to", ans: "It is not feasible to complete in 2 days.", exp: "It is not + adj + to V.", trans: "Việc hoàn thành trong 2 ngày là không khả thi." },
        { q: "escalate / I / issue / will / to / manager. / the / this", ans: "I will escalate this issue to the manager.", exp: "Escalate to someone.", trans: "Tôi sẽ báo cáo vấn đề này lên quản lý." },
        { q: "If / you / lead / sedentary lifestyle / you / will / have / back pain.", ans: "If you lead a sedentary lifestyle, you will have back pain.", exp: "If + HTĐ, S + Will + V.", trans: "Nếu bạn có lối sống ít vận động, bạn sẽ bị đau lưng." }
    ];

    // --- RENDER FUNCTIONS ---

    function renderPart1() {
        const container = document.getElementById('part1-container');
        part1Data.forEach((item, index) => {
            const html = `
                <div class="question-block">
                    <div class="question-text">${index + 1}. ${item.q}</div>
                    <select id="p1-q${index}" class="scorable">
                        <option value="">Choose Definition...</option>
                        <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                        <option value="D">D</option><option value="E">E</option><option value="F">F</option>
                    </select>
                    <span id="fb-p1-q${index}" class="feedback-msg"></span>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkSelect('p1-q${index}', '${item.ans}', 'fb-p1-q${index}', 'btn-exp-p1-${index}', 'btn-trans-p1-${index}')">Check</button>
                        <button id="btn-exp-p1-${index}" class="btn-explain" onclick="toggle('exp-p1-${index}')">Giải thích</button>
                        <button id="btn-trans-p1-${index}" class="btn-trans" onclick="toggle('trans-p1-${index}')">Dịch nghĩa</button>
                    </div>
                    <div id="exp-p1-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p1-${index}" class="info-box trans-box">${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function renderPart2() {
        const container = document.getElementById('part2-container');
        part2Data.forEach((item, index) => {
            let opts = `<option value="">---</option><option value="${item.opts[0]}">${item.opts[0]}</option><option value="${item.opts[1]}">${item.opts[1]}</option>`;
            const html = `
                <div class="question-block">
                    <div class="question-text">
                        ${index + 1}. ${item.pre} <select id="p2-q${index}-1" class="scorable" style="width:130px;">${opts}</select> <span id="fb-p2-q${index}-1"></span>
                        ${item.mid} <select id="p2-q${index}-2" class="scorable" style="width:130px;">${opts}</select> <span id="fb-p2-q${index}-2"></span>
                        ${item.post}
                    </div>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkPart2(${index}, '${item.gap1}', '${item.gap2}')">Check</button>
                        <button id="btn-exp-p2-${index}" class="btn-explain" onclick="toggle('exp-p2-${index}')">Giải thích</button>
                        <button id="btn-trans-p2-${index}" class="btn-trans" onclick="toggle('trans-p2-${index}')">Dịch nghĩa</button>
                    </div>
                    <div id="exp-p2-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p2-${index}" class="info-box trans-box">${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function renderPart3() {
        const container = document.getElementById('part3-container');
        part3Data.forEach((item, index) => {
            let optsHTML = item.opts.map((opt, i) => `<label><input type="radio" name="p3-q${index}" value="${i}" class="scorable-radio"> ${opt}</label>`).join('');
            const html = `
                <div class="question-block">
                    <div class="question-text">${index + 1}. ${item.q}</div>
                    <div>${optsHTML}</div>
                    <div id="fb-p3-q${index}" class="feedback-msg"></div>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkRadio('p3-q${index}', ${item.ans}, 'fb-p3-q${index}', 'btn-exp-p3-${index}', 'btn-trans-p3-${index}')">Check</button>
                        <button id="btn-exp-p3-${index}" class="btn-explain" onclick="toggle('exp-p3-${index}')">Giải thích</button>
                        <button id="btn-trans-p3-${index}" class="btn-trans" onclick="toggle('trans-p3-${index}')">Dịch nghĩa</button>
                    </div>
                    <div id="exp-p3-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p3-${index}" class="info-box trans-box">${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function renderPart4() {
        const container = document.getElementById('part4-container');
        part4Data.forEach((item, index) => {
            let optsHTML = item.opts.map((opt, i) => `<label><input type="radio" name="p4-q${index}" value="${i}" class="scorable-radio"> ${opt}</label>`).join('');
            const html = `
                <div class="question-block">
                    <div class="question-text" style="background:#f9f9f9; padding:10px;">${index + 1}. ${item.context}</div>
                    <div style="margin-top:5px;">${optsHTML}</div>
                    <div id="fb-p4-q${index}" class="feedback-msg"></div>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkRadio('p4-q${index}', ${item.ans}, 'fb-p4-q${index}', 'btn-exp-p4-${index}', 'btn-trans-p4-${index}')">Check</button>
                        <button id="btn-exp-p4-${index}" class="btn-explain" onclick="toggle('exp-p4-${index}')">Giải thích</button>
                        <button id="btn-trans-p4-${index}" class="btn-trans" onclick="toggle('trans-p4-${index}')">Dịch nghĩa</button>
                    </div>
                    <div id="exp-p4-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p4-${index}" class="info-box trans-box">${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function renderPart5() {
        const container = document.getElementById('part5-container');
        part5Data.forEach((item, index) => {
            const html = `
                <div class="question-block">
                    <div class="question-text">${index + 1}. ${item.q.replace('______', `<input type="text" id="p5-q${index}" class="scorable" style="width:120px;">`)} </div>
                    <span id="fb-p5-q${index}" class="feedback-msg"></span>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkText('p5-q${index}', '${item.ans}', 'fb-p5-q${index}', 'btn-exp-p5-${index}', 'btn-trans-p5-${index}')">Check</button>
                        <button id="btn-exp-p5-${index}" class="btn-explain" onclick="toggle('exp-p5-${index}')">Giải thích</button>
                        <button id="btn-trans-p5-${index}" class="btn-trans" onclick="toggle('trans-p5-${index}')">Dịch nghĩa</button>
                    </div>
                    <div id="exp-p5-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p5-${index}" class="info-box trans-box">${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    function renderPart6() {
        const container = document.getElementById('part6-container');
        part6Data.forEach((item, index) => {
            const html = `
                <div class="question-block">
                    <div class="question-text">${index + 1}. Keywords: <span style="font-weight:normal;">${item.q}</span></div>
                    <input type="text" id="p6-q${index}" class="scorable" placeholder="Type sentence here..." style="width:100%;">
                    <div id="fb-p6-q${index}" class="feedback-msg"></div>
                    <div class="btn-group">
                        <button class="btn-check" onclick="checkSentence('p6-q${index}', '${item.ans.replace(/'/g, "\\'")}', 'fb-p6-q${index}', 'btn-exp-p6-${index}', 'btn-trans-p6-${index}')">Check</button>
                        <button id="btn-exp-p6-${index}" class="btn-explain" onclick="toggle('exp-p6-${index}')">Giải thích</button>
                        <button id="btn-trans-p6-${index}" class="btn-trans" onclick="toggle('trans-p6-${index}')">Đáp án</button>
                    </div>
                    <div id="exp-p6-${index}" class="info-box explain-box">${item.exp}</div>
                    <div id="trans-p6-${index}" class="info-box trans-box"><b>Đáp án:</b> ${item.ans}<br><b>Dịch:</b> ${item.trans}</div>
                </div>`;
            container.innerHTML += html;
        });
    }

    // --- UTILS ---
    function toggle(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === "block") ? "none" : "block";
    }

    function cleanStr(str) { return str.trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' '); }

    function setFeedback(isCorrect, inputEl, msgEl, expBtnId, transBtnId) {
        if (isCorrect) {
            inputEl.classList.remove('incorrect-input');
            inputEl.classList.add('correct-input');
            if(msgEl) {
                msgEl.innerHTML = `✅ Chính xác!`;
                msgEl.className = "feedback-msg text-success";
            }
            if(expBtnId) document.getElementById(expBtnId).style.display = 'inline-block';
            if(transBtnId) document.getElementById(transBtnId).style.display = 'inline-block';
            return 1; // Score
        } else {
            inputEl.classList.remove('correct-input');
            inputEl.classList.add('incorrect-input');
            if(msgEl) {
                msgEl.innerHTML = `❌ Sai rồi. <span class="retry-note">Bạn hãy thử lại nhé!</span>`;
                msgEl.className = "feedback-msg text-error";
            }
            return 0;
        }
    }

    // --- CHECK FUNCTIONS ---

    function checkSelect(id, correctVal, msgId, expId, transId) {
        const el = document.getElementById(id);
        const msg = document.getElementById(msgId);
        setFeedback(el.value === correctVal, el, msg, expId, transId);
        updateRunningScore();
    }

    function checkPart2(index, ans1, ans2) {
        const el1 = document.getElementById(`p2-q${index}-1`);
        const el2 = document.getElementById(`p2-q${index}-2`);
        const msg1 = document.getElementById(`fb-p2-q${index}-1`);
        const msg2 = document.getElementById(`fb-p2-q${index}-2`);
        
        const ok1 = (el1.value === ans1);
        const ok2 = (el2.value === ans2);

        setFeedback(ok1, el1, msg1, null, null);
        setFeedback(ok2, el2, msg2, null, null);

        if(ok1 && ok2) {
             document.getElementById(`btn-exp-p2-${index}`).style.display = 'inline-block';
             document.getElementById(`btn-trans-p2-${index}`).style.display = 'inline-block';
        }
        updateRunningScore();
    }

    function checkRadio(name, correctIndex, msgId, expId, transId) {
        const radios = document.getElementsByName(name);
        const msgEl = document.getElementById(msgId);
        let selected = -1;
        
        radios.forEach(r => r.parentElement.style.backgroundColor = "transparent"); // reset

        for(let i=0; i<radios.length; i++) {
            if (radios[i].checked) selected = i;
        }

        if (selected === -1) {
            msgEl.innerHTML = "Vui lòng chọn đáp án."; return;
        }

        if (selected === correctIndex) {
            radios[selected].parentElement.style.backgroundColor = "#eafaf1";
            msgEl.innerHTML = "✅ Chính xác!";
            msgEl.className = "feedback-msg text-success";
            document.getElementById(expId).style.display = 'inline-block';
            document.getElementById(transId).style.display = 'inline-block';
        } else {
            radios[selected].parentElement.style.backgroundColor = "#fceae9";
            msgEl.innerHTML = `❌ Sai rồi. <span class="retry-note">Bạn hãy thử lại nhé!</span>`;
            msgEl.className = "feedback-msg text-error";
        }
        updateRunningScore();
    }

    function checkText(id, correctText, msgId, expId, transId) {
        const el = document.getElementById(id);
        const msg = document.getElementById(msgId);
        const isCorrect = cleanStr(el.value) === cleanStr(correctText);
        setFeedback(isCorrect, el, msg, expId, transId);
        updateRunningScore();
    }

    function checkSentence(id, correctText, msgId, expId, transId) {
        const el = document.getElementById(id);
        const msg = document.getElementById(msgId);
        const isCorrect = cleanStr(el.value) === cleanStr(correctText);
        setFeedback(isCorrect, el, msg, expId, transId);
        updateRunningScore();
    }

    function checkPart7() {
        const answers = ["red light", "showstopper", "overlapping", "simulator", "mitigation", "clarify"];
        let correctCount = 0;
        
        for(let i=1; i<=6; i++) {
            const el = document.getElementById(`p7-q${i}`);
            const msg = document.getElementById(`fb-p7-q${i}`);
            const userVal = cleanStr(el.value);
            
            if(userVal === answers[i-1]) {
                 el.classList.remove('incorrect-input');
                 el.classList.add('correct-input');
                 msg.innerHTML = "✅"; msg.className = "text-success";
                 correctCount++;
            } else {
                 el.classList.remove('correct-input');
                 el.classList.add('incorrect-input');
                 msg.innerHTML = "❌"; msg.className = "text-error";
            }
        }

        const mainMsg = document.getElementById('fb-p7-main');
        if(correctCount === 6) {
            mainMsg.innerHTML = "Tuyệt vời! Bạn đã làm đúng hết.";
            document.getElementById('btn-exp-p7').style.display = 'inline-block';
            document.getElementById('btn-trans-p7').style.display = 'inline-block';
        } else {
            mainMsg.innerHTML = `Bạn làm đúng ${correctCount}/6 câu. Hãy kiểm tra lại các ô màu đỏ nhé!`;
        }
        updateRunningScore();
    }

    // --- SCORING LOGIC ---
    // Total Items: 
    // T1: 6, T2: 4, T3: 4, T4: 3, T5: 5, T6: 4, T7: 6 = 32 points.

    function calculateTotalScore() {
        // Force check all sections first (simulate click)? 
        // No, simpler to just count inputs that have 'correct-input' class
        // But for Radios, we need to check property.
        
        let score = 0;
        
        // 1. Inputs/Selects with 'correct-input' class
        const correctInputs = document.querySelectorAll('.correct-input').length;
        score += correctInputs;

        // 2. Radios (T3, T4)
        // Task 3
        part3Data.forEach((item, idx) => {
            const radios = document.getElementsByName(`p3-q${idx}`);
            if(radios[item.ans].checked) score++;
        });
        // Task 4
        part4Data.forEach((item, idx) => {
            const radios = document.getElementsByName(`p4-q${idx}`);
            if(radios[item.ans].checked) score++;
        });

        document.getElementById('total-score').innerText = score;
        
        // Copy to clipboard
        const name = document.getElementById('studentName').value || "Học viên";
        const resultText = `Kết quả bài Review:\nHọc viên: ${name}\nĐiểm số: ${score}/32`;
        
        navigator.clipboard.writeText(resultText).then(() => {
            alert(`${resultText}\n\n(Đã sao chép kết quả! Bạn hãy paste gửi cho giáo viên nhé)`);
        });
    }

    function updateRunningScore() {
        // Optional: Updates score real-time visually without alerting
        // Simple logic duplicate of above but without alert
        let score = 0;
        score += document.querySelectorAll('.correct-input').length;
        part3Data.forEach((item, idx) => {
            const radios = document.getElementsByName(`p3-q${idx}`);
            if(radios[item.ans].checked) score++;
        });
        part4Data.forEach((item, idx) => {
            const radios = document.getElementsByName(`p4-q${idx}`);
            if(radios[item.ans].checked) score++;
        });
        document.getElementById('total-score').innerText = score;
    }

    // INIT
    window.onload = function() {
        renderPart1();
        renderPart2();
        renderPart3();
        renderPart4();
        renderPart5();
        renderPart6();
    };

</script>
</body>
</html>
